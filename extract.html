<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extract Data - Novel Memory</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">ðŸ“š Novel Memory</div>
            <div class="nav-center" id="storySelector">
                <!-- Story selector rendered by JS -->
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Prompt Builder</a>
                <a href="extract.html" class="nav-link active">Extract</a>
                <a href="memory.html" class="nav-link">Memory</a>
                <a href="stories.html" class="nav-link">ðŸ“– Stories</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <main class="main-content" style="max-width: 900px; margin: 0 auto;">
            <!-- Story Input -->
            <div class="card">
                <div class="card-title">Paste Gemini's Story Output</div>
                <textarea 
                    id="storyInput" 
                    class="story-input" 
                    style="min-height: 200px;"
                    placeholder="Paste the story generated by Gemini here...

Example: The dragon soared over Winterfell as Jon Snow drew his sword Longclaw. Beside him, Arya watched with keen eyes..."
                ></textarea>
            </div>

            <!-- Extraction Types -->
            <div class="card">
                <div class="card-title">What to Extract</div>
                <p class="hint">Click Ã— to remove types. Add custom types below.</p>
                <div class="type-tags-input" id="typeTags">
                    <!-- Type tags rendered here -->
                </div>
                <div class="type-input-wrapper">
                    <input 
                        type="text" 
                        id="customTypeInput" 
                        placeholder="Add custom type (e.g., weapon, spell)"
                    >
                    <button class="btn btn-secondary" onclick="addCustomType()">+ Add</button>
                </div>
            </div>

            <!-- Generated Extraction Prompt -->
            <div class="card">
                <div class="card-title">Generated Extraction Prompt</div>
                <textarea 
                    id="promptOutput" 
                    class="prompt-output" 
                    readonly
                    placeholder="The extraction prompt will appear here..."
                ></textarea>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="copyPrompt()">
                        ðŸ“‹ Copy Prompt
                    </button>
                    <button class="btn btn-secondary" onclick="resetTypes()">
                        ðŸ”„ Reset Types
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <div class="card-title">How to Use</div>
                <ol style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 2;">
                    <li>Paste the story from Gemini into the text box above</li>
                    <li>Adjust the types you want to extract</li>
                    <li>Copy the generated extraction prompt</li>
                    <li>Paste the prompt into Gemini</li>
                    <li>Copy Gemini's JSON response</li>
                    <li>Go to <a href="memory.html" style="color: var(--primary);">Memory</a> page and import the JSON</li>
                </ol>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/search.js"></script>
    <script src="js/merge.js"></script>
    <script src="js/prompt.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Default types
        const DEFAULT_TYPES = ['character', 'location', 'item', 'event'];
        
        // State
        let extractTypes = [];

        // DOM Elements
        const storyInput = document.getElementById('storyInput');
        const promptOutput = document.getElementById('promptOutput');
        const typeTagsContainer = document.getElementById('typeTags');
        const customTypeInput = document.getElementById('customTypeInput');

        // Initialize
        function init() {
            UI.renderStorySelector('storySelector');
            resetTypes();

            // Event listeners
            storyInput.addEventListener('input', updatePrompt);
            customTypeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addCustomType();
            });
        }

        // Reset to default types + types from memory
        function resetTypes() {
            const memoryTypes = Storage.getTypes();
            const allTypes = new Set([...DEFAULT_TYPES, ...memoryTypes]);
            extractTypes = Array.from(allTypes).sort();
            renderTypeTags();
            updatePrompt();
        }

        // Render type tags
        function renderTypeTags() {
            if (extractTypes.length === 0) {
                typeTagsContainer.innerHTML = '<span style="color: var(--text-secondary);">No types selected</span>';
                return;
            }

            let html = '';
            extractTypes.forEach(type => {
                html += `
                    <span class="tag" data-type="${UI.escapeHtml(type)}">
                        ${UI.escapeHtml(type)}
                        <span class="tag-remove" data-type="${UI.escapeHtml(type)}">Ã—</span>
                    </span>
                `;
            });

            typeTagsContainer.innerHTML = html;

            // Add remove handlers
            typeTagsContainer.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeType(btn.dataset.type);
                });
            });
        }

        // Remove a type
        function removeType(type) {
            extractTypes = extractTypes.filter(t => t !== type);
            renderTypeTags();
            updatePrompt();
        }

        // Add custom type
        function addCustomType() {
            const type = customTypeInput.value.trim().toLowerCase();
            if (!type) return;

            if (extractTypes.includes(type)) {
                UI.toast('Type already exists!', true);
                return;
            }

            extractTypes.push(type);
            extractTypes.sort();
            customTypeInput.value = '';
            renderTypeTags();
            updatePrompt();
            UI.toast(`Added type: ${type}`);
        }

        // Update prompt
        function updatePrompt() {
            const story = storyInput.value.trim();

            if (!story) {
                promptOutput.value = '';
                return;
            }

            if (extractTypes.length === 0) {
                promptOutput.value = 'Please select at least one type to extract.';
                return;
            }

            const prompt = Prompt.buildExtraction(story, extractTypes);
            promptOutput.value = prompt;
        }

        // Copy prompt
        function copyPrompt() {
            const text = promptOutput.value;
            if (!text) {
                UI.toast('Nothing to copy!', true);
                return;
            }
            UI.copyToClipboard(text);
        }

        // Start
        init();
    </script>
</body>
</html>